PRD v2 - Breathing Session PWA (iOS-first, no backend)

UPDATE (v2.3, February 23, 2026) - ACTIVE OVERRIDES

This section supersedes v2.2/v2.1 and any conflicting statements below.

1) Product naming

User-facing product name is:
Iki Gong

Apply consistently in:
- app UI title
- browser document title
- PWA manifest (name/short_name)
- Media Session metadata
- README/rules/docs

2) Volume policy

In-app volume control is removed from MVP.

Do not expose volume slider in UI.

Session audio element volume is fixed at 100% (`audio.volume = 1`).

User controls loudness via device/system volume only.

Legacy storage key `masterVolume` must be removed during settings load.

3) Brandbook compliance (mandatory visual layer)

Source:
/Users/vpavlin/PycharmProjects/breeth/brandbook.txt

Required constraints:
- no gradients
- no glassmorphism
- no heavy shadows
- no pure white #FFFFFF
- no pure black #000000
- one sans-serif family, max two weights (regular/medium)
- spacing/radius/button sizing must follow brandbook ranges

4) PWA cache rollout

When app shell branding/styling changes, bump service worker cache version
to force fresh shell assets on iOS PWA updates.

UPDATE (v2.2, February 23, 2026) - ACTIVE OVERRIDES

This section supersedes v2.1 and any conflicting statements below.

1) Modes and UI

Mode types are:

Equal (N-N) with N selectable from 4 to 7

Box 4-4-4-4

4-7-8

Equal slider applies only to Equal mode.

2) Durations

Only:

5, 10, 20 minutes

3) Active track set (required for validation)

18 files total:

Equal:
N=4,5,6,7 x durations 5/10/20 = 12 files

Box:
3 files

4-7-8:
3 files

Legacy files (for 15/25/30 and even-88) may remain in repository but are excluded from active validation.

4) Audio source files (authoritative)

Inhale sample:
/Users/vpavlin/PycharmProjects/breeth/bowls_3_1.mp3

Hold sample:
/Users/vpavlin/PycharmProjects/breeth/bowls_3_2.mp3

Exhale sample:
/Users/vpavlin/PycharmProjects/breeth/bowls_3_3.mp3

5) Phase rendering rule (strict)

Each phase is filled by its assigned sample for the full phase duration:

if sample longer than phase -> trim

if sample shorter than phase -> loop and trim

No per-second ticking events in hold phases.

6) Mode phase assignment

Equal N-N:
inhale N sec -> bowls_3_1
exhale N sec -> bowls_3_3

Box 4-4-4-4:
inhale 4 sec -> bowls_3_1
hold 4 sec -> bowls_3_2
exhale 4 sec -> bowls_3_3
hold 4 sec -> bowls_3_2

4-7-8:
inhale 4 sec -> bowls_3_1
hold 7 sec -> bowls_3_2
exhale 8 sec -> bowls_3_3

7) Storage normalization

equalSeconds must be clamped to 4..7

duration must be normalized to nearest of {5,10,20}, tie rule: 15 -> 20

legacy selectedMode migration remains required.

8) Validation gates

Before release and in CI:

validate required active set (18 tracks)

validate durations

validate active-set size thresholds

UPDATE (v2.1, February 23, 2026) - HISTORICAL (SUPERSEDED BY v2.2)

This section supersedes any conflicting statements below.
If a lower section mentions "3 modes", "18 tracks", "4-4 only", or legacy storage fields,
the v2.1 overrides are the source of truth.

The following sections are explicitly overridden by v2.1:
2 (In scope mode list), 4.D (fixed modes), 5.4 (track count/modes),
5.7 (storage keys), 7.1 (mode labels), 8.3 (cycle set),
8.4 (asset size target wording), 8.5 (required naming list),
12.1 (functional acceptance mode count), 13 (test matrix examples), 14.2 (audio track count).

1) Modes and UI

Mode types are now:

Equal (N-N) with N selectable from 4 to 8 via slider

Box 4-4-4-4

4-7-8

Equal slider applies only to Equal mode.

2) Track set size

Session tracks are now 42 files total (not 18):

Equal:
N=4,5,6,7,8 x durations 5/10/15/20/25/30 = 30 files

Box:
6 files

4-7-8:
6 files

3) Filename convention

Equal:
even-44-5m.mp3 ... even-88-30m.mp3

Box:
box-4444-5m.mp3 ... box-4444-30m.mp3

4-7-8:
relax-478-5m.mp3 ... relax-478-30m.mp3

4) Equal mode audio behavior

For Equal N-N:

Inhale gong at cycle start

Exhale gong at +N seconds

No tick sounds

5) Persistence and migration

Current storage model:
selectedModeType + equalSeconds + selectedDuration + masterVolume

Legacy selectedMode migration must remain supported:
even44 -> modeType=equal, equalSeconds=4
box4444 -> modeType=box4444
relax478 -> modeType=relax478

6) Validation gates

Before release and in CI:

validate expected track set (42 files)

validate durations

validate asset size thresholds

7) Equal mode timing definition (normative)

Equal mode uses selectable N where N in {4,5,6,7,8}.

Cycle length = 2N seconds:

0-N inhale

N-2N exhale

Events:

t=cycleStart inhale gong

t=cycleStart+N exhale gong

No ticks in Equal mode.

1) Product overview
Goal

Build a browser/PWA app for breathing exercises with audio-guided sessions that has the best possible chance to continue playback on iPhone when the screen is locked.

Core concept

The app does not run breathing phase logic in background using JS timers.
Instead, each session is played as one pre-generated audio track (like a music file), because iOS is generally more reliable with continuous media playback than with background JS timing.

Why this approach

No backend required

Simple static hosting

Better lock-screen behavior on iOS than timer-based web apps

Easier to make stable for MVP

2) Scope
In scope (MVP)

Static web app + PWA (installable on iPhone)

3 breathing modes:

4-4

Box 4-4-4-4

4-7-8

Fixed session durations:

5 / 10 / 15 / 20 / 25 / 30 minutes

Distinct sounds:

Inhale gong

Exhale gong

Soft tick during hold phases only

Playback controls:

Start

Pause

Resume

Stop

Session UI:

Mode

Duration

Remaining time

Playback state

Master volume control

PWA install guidance for iPhone

Offline support for cached tracks:

App shell always cached

Audio tracks cached on first use or pre-cached (depending on total size)

Out of scope (MVP)

Backend, accounts, cloud sync

Telegram WebApp integration (phase 2)

Arbitrary custom breathing timings

Voice guidance

Push notifications

HealthKit / Apple Health

Complex animations synced while screen is locked

User analytics SDKs

3) Target users and platforms
Primary target

iPhone users using:

Safari

Installed PWA (Add to Home Screen)

Secondary target

Android (Chrome/PWA) - best effort

Main usage pattern

User selects mode + duration

Starts session

Locks screen

Puts phone in pocket

Follows audio cues only

This is an audio-first product.

4) Non-negotiable product decisions

These decisions must not be changed without approval.

A. No backend

The app must be fully static and hostable on GitHub Pages / Cloudflare Pages.

B. Audio-first session engine

Session timing is encoded into pre-generated audio files, not executed by live JS timers.

C. Fixed durations only

Only:

5, 10, 15, 20, 25, 30 minutes

D. Fixed modes only

Only:

4-4

Box 4-4-4-4

4-7-8

E. Sound rules (strict)

Inhale start -> inhale gong

Exhale start -> exhale gong

Tick only during hold phases

No ticks during inhale/exhale

F. Timing tolerance

Perceived timing tolerance of approximately ±100-200 ms is acceptable.

5) Functional requirements
5.1 Home screen
User can

Select breathing mode

Select session duration

Set master volume

Start session

See basic iPhone usage guidance (PWA and sound)

Requirements

A mode and duration must always be selected

Last used settings must persist in local storage

Start button must be enabled only when the selected track is ready or loading state is clearly shown

Defaults

Default mode: 4-4

Default duration: 10 min

Default volume: 80%

iPhone guidance (must be visible)

Show a short help block (or first-run modal):

Turn sound on

Add app to Home Screen

Start session from Home Screen

Lock screen and put phone in pocket

Also mention:

Background playback behavior may vary by iPhone model, iOS version, and system settings (for example Low Power Mode)

5.2 Session playback screen
User can

See selected mode and duration

See remaining time (countdown)

See playback state (Playing, Paused)

Pause

Resume

Stop

See completion state when session ends

Requirements

Session starts only after explicit user interaction (Start tap)

Session playback must use one single audio file via HTML <audio>

Countdown must be derived from:

audio.currentTime

audio.duration (after metadata is loaded)

UI countdown is best-effort while app is backgrounded

It may stop rendering while screen is locked

It must resync correctly after app returns to foreground

If playback completes naturally:

Show Session complete

Show buttons: Start again, Back

Seek/scrub behavior

Seeking/scrubbing is disabled in MVP (to reduce complexity and avoid desync confusion)

5.3 Playback interruptions (system events)

This is required because it is common on iPhone.

App must handle interruptions gracefully

Examples:

Incoming call

Siri

Other media starts playing

Headphones disconnected

Required behavior

Detect pause/interruption if possible via media events

Reflect state in UI (usually Paused or Interrupted)

Do not auto-restart unexpectedly

Allow user to:

Resume

Restart session

Stop and return

5.4 Audio behavior and event rules

There are 18 pre-generated session tracks total.

Modes x durations = 18 files
Modes

4-4

Box 4-4-4-4

4-7-8

Durations

5m, 10m, 15m, 20m, 25m, 30m

Audio event rules by mode
Mode: 4-4

Inhale starts -> inhale gong

Exhale starts -> exhale gong

No tick sounds

Mode: Box 4-4-4-4

Inhale starts -> inhale gong

Hold after inhale (4s) -> tick once per second

Exhale starts -> exhale gong

Hold after exhale (4s) -> tick once per second

Mode: 4-7-8

Inhale starts -> inhale gong

Hold (7s) -> tick once per second

Exhale starts -> exhale gong

No hold after exhale

5.5 Volume behavior

MVP uses master volume only.

Requirements

Master volume affects the session <audio> element

Volume value persists in local storage

Range: 0% to 100%

Note - separate gong/tick volume sliders are phase 2.

5.6 Offline and PWA behavior
PWA requirements

App must be installable as PWA

App shell must be cached

Audio tracks must be cached:

either pre-cached (if total size acceptable)

or cached on first use (required fallback)

Offline behavior requirements

If the selected track is cached, session must play offline

If the selected track is not cached and user is offline:

show clear error message

do not fail silently

Important clarification

“Works offline” means works offline for cached tracks, not necessarily all 18 tracks after first visit.

5.7 Persistence (local storage)

Store locally:

selectedMode

selectedDuration

masterVolume

installHintDismissed (optional)

lastUsedAt (optional)

Do not store:

personal data

remote identifiers

analytics IDs

6) State machine (required)

Executor must implement explicit app states to avoid control bugs.

States

idle

loading

playing

paused

completed

error

Required transitions

idle -> loading -> playing

playing -> paused

paused -> playing

playing -> completed

playing -> idle (Stop)

paused -> idle (Stop)

loading -> error

playing -> error

paused -> error

State behavior notes

loading means selected track is being loaded/prepared

completed only for natural end of playback

error must include user-visible message and recovery action (Retry, Back)

7) UX requirements
7.1 Mode labels (UI)

Use simple labels in MVP:

4-4

Box 4-4-4-4

4-7-8

7.2 Session screen layout (minimal, audio-first)

Must show:

Mode label

Session duration

Remaining time (mm:ss)

Playback state (Playing, Paused)

Controls:

Pause/Resume

Stop

Optional (nice-to-have only):

simple pulse animation

phase text label

Do not make phase label a core requirement in MVP because playback is track-based and phase parsing is not required for success.

7.3 Mobile-first layout

UI must work in:

iPhone Safari

iPhone PWA standalone

future Telegram mobile webview (phase 2)

Future compatibility note

PWA-specific install prompts must be optional and hidden/disabled when later embedded in Telegram WebView.

8) Audio generation specification (critical)

This section is strict. Executor must not improvise timing logic.

8.1 Source sounds (3 files)

Executor must prepare or use provided source samples:

gong_inhale

gong_exhale

tick_soft

Source sound requirements

Short samples

Clean attack

No harsh clipping

Inhale and exhale clearly different

Tick soft and non-intrusive

8.2 Mixing/mastering rules

Tick must be clearly quieter than both gongs

No clipping in final tracks

No obvious pops/clicks at track boundaries

Final output normalized to safe level (for example peak near -1 dBFS)

Tick should remain audible in both headphones and phone speaker, but still soft

8.3 Track composition rules

Each final file is one continuous audio track of exact target length:

5:00

10:00

15:00

20:00

25:00

30:00

Cycle timing definitions
4-4

Cycle length = 8s

0-4s inhale

4-8s exhale

Box 4-4-4-4

Cycle length = 16s

0-4s inhale

4-8s hold

8-12s exhale

12-16s hold

4-7-8

Cycle length = 19s

0-4s inhale

4-11s hold

11-19s exhale

Event scheduling examples (normative)
4-4 (8s cycle)

t=0.0 inhale gong

t=4.0 exhale gong

t=8.0 inhale gong

t=12.0 exhale gong

repeat

Box 4-4-4-4 (16s cycle)

t=0.0 inhale gong

t=4.0 hold starts, ticks at 4.0, 5.0, 6.0, 7.0

t=8.0 exhale gong

t=12.0 hold starts, ticks at 12.0, 13.0, 14.0, 15.0

repeat

4-7-8 (19s cycle)

t=0.0 inhale gong

t=4.0 hold starts, ticks at 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0

t=11.0 exhale gong

repeat

Tick timing rule (strict)

Tick occurs at the start of each hold second

Tick frequency is exactly 1 tick per second

Ticks occur only during hold phases

End-of-track rule

If the next event/cycle would exceed the selected duration:

Cut the final track at the exact target duration

Do not extend track beyond selected duration

Truncated last cycle is acceptable

8.4 Audio format and size requirements
Recommended format

For broad iPhone compatibility:

Primary output: MP3 (preferred for MVP)

Optional secondary output: .m4a if desired

Encoding guidance

Prefer mono

Bitrate guideline: around 96-128 kbps (mono is sufficient)

Use consistent sample rate across all files

Asset size target

Keep total size of all 18 final tracks reasonable (target roughly under 100 MB if possible)

If total size is too large:

do not pre-cache all tracks

use on-demand caching for audio files

8.5 File naming and lookup (strict)

File names must be deterministic and stable.

Required naming

even-44-5m.mp3

even-44-10m.mp3

even-44-15m.mp3

even-44-20m.mp3

even-44-25m.mp3

even-44-30m.mp3

box-4444-5m.mp3

box-4444-10m.mp3

box-4444-15m.mp3

box-4444-20m.mp3

box-4444-25m.mp3

box-4444-30m.mp3

relax-478-5m.mp3

relax-478-10m.mp3

relax-478-15m.mp3

relax-478-20m.mp3

relax-478-25m.mp3

relax-478-30m.mp3

Frontend mapping requirement

Frontend must resolve file path via a deterministic mapping function, not 18 hardcoded conditionals.

Examples:

mode=even44, duration=10 -> even-44-10m.mp3

mode=box4444, duration=15 -> box-4444-15m.mp3

mode=relax478, duration=20 -> relax-478-20m.mp3

9) Technical implementation requirements
9.1 Frontend stack

Allowed:

Plain HTML/CSS/JS

Vite + vanilla JS/TS

Lightweight framework if needed

Recommendation for MVP

Use plain JS or Vite + vanilla TS to keep bundle small.

Do not overengineer.

9.2 Playback implementation (required)
Playback engine

Use standard HTML media element:

<audio> is the source of truth for session playback

Do not implement session events using chained setTimeout or setInterval.

Why

OS should treat the session as media playback, not background JS execution.

9.3 Countdown and UI sync

Countdown must be derived from <audio>.currentTime and <audio>.duration

Wait for metadata before trusting duration

UI countdown may stop rendering while app is backgrounded

On foreground/visibility return, UI must resync to actual audio.currentTime

Do not use a separate timer as source of truth.

9.4 Track loading and preload strategy (required)

To reduce start lag and playback failures:

Requirements

Preload the selected track after mode/duration selection changes

Use preload="auto" (or equivalent preload strategy)

Show loading state while metadata or track is not ready

If playback is attempted before ready, handle gracefully (no silent failure)

9.5 Media Session API (nice-to-have but recommended)

If supported by the browser:

Set media session metadata (title, mode, duration)

Register media action handlers for play/pause

This can improve lock-screen UX on supported devices, but must be optional (not required for MVP success).

9.6 PWA manifest requirements

Manifest must include:

name

short_name

icons (at least 192 and 512)

display: standalone

theme_color

background_color

start_url

9.7 Service worker and caching

Service worker must cache:

App shell (HTML/CSS/JS/icons/manifest)

Audio assets (pre-cached or lazy-cached)

Cache strategy

App shell: cache-first

Audio: cache-first (acceptable for MVP)

Versioned cache names required

Old caches should be cleaned on update

10) Error handling requirements

Executor must implement user-visible errors. No silent failures.

10.1 Audio load failure

Example message:

“Could not load session audio. Check connection and try again.”

10.2 Playback blocked by browser policy

Example message:

“Audio playback was blocked. Tap Start again.”

10.3 Offline but selected track is not cached

Example message:

“This session is not available offline yet. Connect once to download it.”

10.4 Unsupported features

If a feature is unsupported (for example some PWA behavior):

show warning if needed

continue best effort

do not hard-fail app startup

10.5 Interruption handling

If playback is interrupted by system/media event:

show paused/interrupted state

provide Resume and Restart

do not auto-resume unexpectedly

11) Performance and reliability requirements
11.1 Performance

Home screen interactive within ~2s on a modern iPhone after first load

Start-to-audio latency should be low on cached tracks (target under ~500 ms)

UI must remain responsive during playback

11.2 Reliability

Core session behavior must not depend on JS phase timers

Playback should continue as reliably as possible in iPhone PWA mode after screen lock

App must recover cleanly after returning to foreground

11.3 Compatibility target

Required:

iOS Safari (recent)

iOS PWA standalone (Add to Home Screen)

Best effort:

Android Chrome / PWA

12) QA and acceptance criteria
12.1 Functional acceptance

 User can select any of 3 modes

 User can select any of 6 durations

 Correct audio file is mapped and played for every combination

 User can Start / Pause / Resume / Stop

 Remaining time updates correctly based on <audio>

 Completion state appears when track ends

 Last mode/duration/volume persist after reload

12.2 Audio acceptance

 Inhale and exhale gongs are audibly different

 Ticks are present only during hold phases

 No ticks in 4-4 mode

 Tick is softer than gong

 No clipping or obvious pops in final tracks

 Each final track has exact target duration (5/10/15/20/25/30 min)

12.3 PWA/offline acceptance

 App can be added to Home Screen on iPhone

 App launches in standalone mode

 App shell works offline after caching

 At least one previously cached session track plays offline

 If track is not cached offline, app shows clear error

12.4 iOS lock-screen acceptance (best-effort, device-specific)

This must be treated as compatibility verification, not a universal guarantee.

 On at least one target iPhone device/iOS version, in PWA mode, a session audio track continues for several minutes after screen lock

 Tested iPhone model and iOS version are documented in README

 After unlock, app UI correctly reflects playback state or can recover safely (resume/restart)

13) Test matrix (minimum manual QA)
Required platforms
iPhone

Safari

Installed PWA

Required scenarios

4-4, 5m - Start / Pause / Resume / Stop

Box 4-4-4-4, 10m - verify tick during both holds

4-7-8, 10m - verify tick only in 7s hold

Change mode/duration - verify correct file loads

Lock screen test in PWA mode (10m minimum)

Offline replay of previously used session

Reload app - verify settings persistence

Simulate interruption (other audio or call if possible) - verify UI and recovery behavior

Optional platform
Android

Chrome

PWA

Basic playback and offline check

14) Deliverables

Executor must provide all of the following.

14.1 Application

Source code repository

Production-ready static build

PWA assets and service worker included

14.2 Audio assets

Source sound files:

inhale gong

exhale gong

soft tick

All 18 final session tracks

Script or process used to generate tracks (recommended script, not manual-only DAW process)

14.3 Documentation (README.md)

Must include:

How to run locally

How to deploy to GitHub Pages / Cloudflare Pages

How to regenerate audio tracks

File naming convention

Tested iPhone model(s) and iOS version(s)

Known limitations (especially iOS background behavior variability)

14.4 Deployment

HTTPS URL to working build

Confirmed PWA install works on iPhone

15) Suggested project structure (recommended)
/breathing-pwa
  /public
    /audio
      even-44-5m.mp3
      even-44-10m.mp3
      ...
      box-4444-30m.mp3
      relax-478-30m.mp3
    /icons
      icon-192.png
      icon-512.png
    manifest.json
  /src
    /ui
    /player
    /storage
    /pwa
    /utils
  index.html
  service-worker.js (or generated equivalent)
  README.md

If using plain JS without bundler, structure can be simplified, but keep:

/audio

manifest

service worker

clear separation of UI/player/storage logic

16) Common mistakes to avoid (explicit)
1. Using JS timers for phase scheduling

Do not implement core breathing timing with setInterval / setTimeout.

2. Using WebAudio scheduling as the main playback engine

Do not rely on WebAudio-only playback for sessions.
Use <audio> with pre-generated track.

3. No explicit state machine

Without state management, pause/resume/complete/errors will break.

4. Wrong tick behavior

Tick must be only on hold phases.
No ticks in 4-4 mode.

5. Wrong tick timing

Tick must be at start of each hold second (for example 4.0, 5.0, 6.0, 7.0).

6. Misleading offline claim

Offline works only for cached tracks.
Do not imply all tracks are available offline after first visit unless pre-cached.

7. No preload strategy

If selected track is not preloaded, start latency and playback reliability may suffer.

8. Overcomplicated UI

MVP is audio-first. Keep UI simple and dependable.

17) Phase 2 readiness (not in MVP)

This project should be easy to adapt later for Telegram WebApp.

Future phase (not part of current delivery)

Telegram WebApp wrapper

Hide PWA install prompts in Telegram context

More presets

Separate gong/tick volumes

Better visuals and on-screen guidance

Download-all-tracks button

Haptics where available

18) Final implementation summary for executor

Build a static iOS-first PWA breathing app that plays one pre-generated audio track per session.

Critical success criteria

Correct audio cues (inhale gong, exhale gong, hold ticks only)

Reliable playback with minimal controls

PWA installable on iPhone

Offline playback for cached tracks

Best-effort lock-screen playback on iPhone

Clean handling of pause/resume/interruptions/errors

Visual polish is secondary. Reliability and simplicity are primary.
